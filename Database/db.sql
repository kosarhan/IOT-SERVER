-- Creating Tables
CREATE TABLE "Node"
(
    id integer NOT NULL,
    name text NOT NULL,
    "temperatureAlertId" integer,
    "createdAt" timestamp with time zone NOT NULL,
    "updatedAt" timestamp with time zone,
    "deletedAt" timestamp with time zone,
    PRIMARY KEY (id),
    FOREIGN KEY ("temperatureAlertId") REFERENCES "TemperatureAlert"(id);
);

CREATE TABLE "Temperature"
(
    id SERIAL NOT NULL,
    value float NOT NULL,
    "nodeId" integer NOT NULL,
    "createdAt" timestamp with time zone NOT NULL,
    "updatedAt" timestamp with time zone,
    "deletedAt" timestamp with time zone,
    PRIMARY KEY (id),
	FOREIGN KEY ("nodeId") REFERENCES "Node"(id)
);

CREATE TABLE "Humidity"
(
    id SERIAL NOT NULL,
    value float NOT NULL,
    "nodeId" integer NOT NULL,
    "createdAt" timestamp with time zone NOT NULL,
    "updatedAt" timestamp with time zone,
    "deletedAt" timestamp with time zone,
    PRIMARY KEY (id),
	FOREIGN KEY ("nodeId") REFERENCES "Node"(id)
);

CREATE TABLE "TemperatureAlert"
(
    id SERIAL NOT NULL,
    name text NOT NULL,
    "minValue" float NOT NULL,
    "maxValue" float NOT NULL,
    "createdAt" timestamp with time zone NOT NULL,
    "updatedAt" timestamp with time zone,
    "deletedAt" timestamp with time zone,
    PRIMARY KEY (id)
);

CREATE TABLE "HumidityAlert" (
    id SERIAL NOT NULL,
    name text NOT NULL,
    "minValue" float NOT NULL,
    "maxValue" float NOT NULL,
    "createdAt" timestamp with time zone NOT NULL,
    "updatedAt" timestamp with time zone,
    "deletedAt" timestamp with time zone,
    PRIMARY KEY (id)
);

CREATE TABLE "Alert" (
    "nodeId" int NOT NULL,
	"temperatureAlertId" int,
	"humidityAlertId" int,
    "createdAt" timestamp with time zone NOT NULL,
    "updatedAt" timestamp with time zone,
    "deletedAt" timestamp with time zone,
	FOREIGN KEY ("nodeId") REFERENCES "Node"(id),
	FOREIGN KEY ("temperatureAlertId") REFERENCES "TemperatureAlert"(id),
	FOREIGN KEY ("humidityAlertId") REFERENCES "HumidityAlert"(id)
);

-- Creating Trigger Functions

CREATE OR REPLACE FUNCTION process_insert_value() RETURNS TRIGGER AS $insert_value$
	DECLARE
    	node_count INTEGER;
    	deleted_node_count INTEGER;
    BEGIN
        --
        -- If node that has nodeId in the query does not exist, create the node
        --
		node_count := (SELECT COUNT(*) FROM "Node" WHERE "id" = NEW."nodeId" AND "deletedAt" IS NULL);
		deleted_node_count := (SELECT COUNT(*) FROM "Node" WHERE "id" = NEW."nodeId" AND "deletedAt" IS NOT NULL);
		
		IF (deleted_node_count = 0) THEN
			IF (TG_OP = 'INSERT' AND node_count = 0) THEN
				INSERT INTO "Node"("id", "name", "createdAt", "updatedAt") VALUES (NEW."nodeId", CONCAT('Node Address ', NEW."nodeId"), NOW(), NOW());
			ELSIF (TG_OP = 'UPDATE' AND node_count = 0) THEN
				INSERT INTO "Node"("id", "name", "createdAt", "updatedAt") VALUES (NEW."nodeId", CONCAT('Node Address ', NEW."nodeId"), NOW(), NOW());
			END IF;
			
			RETURN NEW;
		ELSE
			RETURN NULL;
		END IF;
    END;

$insert_value$ LANGUAGE plpgsql;

CREATE TRIGGER insert_temperature_value BEFORE INSERT OR UPDATE ON "Temperature" FOR EACH ROW EXECUTE FUNCTION process_insert_value();
CREATE TRIGGER insert_humidity_value BEFORE INSERT OR UPDATE ON "Humidity" FOR EACH ROW EXECUTE FUNCTION process_insert_value();


-- Creating Example Data

-- INSERT INTO "Node" ("id", "name", "createdAt", "updatedAt") VALUES
-- 	(2, 'Node Address 1', '2022-02-08 15:30:00.00+03', '2022-02-08 15:30:00.00+03'),
-- 	(3, 'Node Address 2', '2022-02-08 15:30:00.00+03', '2022-02-08 15:30:00.00+03'),
-- 	(4, 'Node Address 3', '2022-02-08 15:30:00.00+03', '2022-02-08 15:30:00.00+03'),
-- 	(5, 'Node Address 4', '2022-02-08 15:30:00.00+03', '2022-02-08 15:30:00.00+03');

-- INSERT INTO "Temperature" ("value", "nodeId", "createdAt", "updatedAt") VALUES
-- 	(23.8, 2, '2022-02-08 15:40:00.00+03', '2022-02-08 15:40:00.00+03'),
-- 	(24.4, 2, '2022-02-08 15:41:00.00+03', '2022-02-08 15:41:00.00+03'),
-- 	(21.0, 2, '2022-02-08 15:42:00.00+03', '2022-02-08 15:42:00.00+03'),
-- 	(20.5, 2, '2022-02-08 15:43:00.00+03', '2022-02-08 15:43:00.00+03'),
-- 	(20.9, 2, '2022-02-08 15:44:00.00+03', '2022-02-08 15:44:00.00+03'),
-- 	(24.6, 3, '2022-02-08 15:40:00.00+03', '2022-02-08 15:40:00.00+03'),
-- 	(20.2, 3, '2022-02-08 15:41:00.00+03', '2022-02-08 15:41:00.00+03'),
-- 	(20.4, 3, '2022-02-08 15:42:00.00+03', '2022-02-08 15:42:00.00+03'),
-- 	(21.1, 3, '2022-02-08 15:43:00.00+03', '2022-02-08 15:43:00.00+03'),
-- 	(20.2, 3, '2022-02-08 15:44:00.00+03', '2022-02-08 15:44:00.00+03'),
-- 	(22.7, 4, '2022-02-08 15:40:00.00+03', '2022-02-08 15:40:00.00+03'),
-- 	(20.7, 4, '2022-02-08 15:41:00.00+03', '2022-02-08 15:41:00.00+03'),
-- 	(20.0, 4, '2022-02-08 15:42:00.00+03', '2022-02-08 15:42:00.00+03'),
-- 	(24.4, 4, '2022-02-08 15:43:00.00+03', '2022-02-08 15:43:00.00+03'),
-- 	(20.1, 4, '2022-02-08 15:44:00.00+03', '2022-02-08 15:44:00.00+03'),
-- 	(22.8, 5, '2022-02-08 15:40:00.00+03', '2022-02-08 15:40:00.00+03'),
-- 	(20.8, 5, '2022-02-08 15:41:00.00+03', '2022-02-08 15:41:00.00+03'),
-- 	(20.9, 5, '2022-02-08 15:42:00.00+03', '2022-02-08 15:42:00.00+03'),
-- 	(22.8, 5, '2022-02-08 15:43:00.00+03', '2022-02-08 15:43:00.00+03'),
-- 	(22.8, 5, '2022-02-08 15:44:00.00+03', '2022-02-08 15:44:00.00+03');

INSERT INTO "Temperature" ("value", "createdAt", "updatedAt", "nodeId") VALUES
	(211.13,'2022-02-10T13:20:07.204Z','2022-02-10T13:20:07.204Z',7),
    (211.13,'2022-02-10T13:21:09.222Z','2022-02-10T13:21:09.222Z',7),
    (211.13,'2022-02-10T13:23:11.159Z','2022-02-10T13:23:11.159Z',7),
    (211.13,'2022-02-10T13:25:12.993Z','2022-02-10T13:25:12.993Z',7),
    (211.13,'2022-02-10T13:27:14.890Z','2022-02-10T13:27:14.890Z',7),
    (211.13,'2022-02-10T13:29:17.441Z','2022-02-10T13:29:17.441Z',7),
    (211.13,'2022-02-10T13:30:19.440Z','2022-02-10T13:30:19.440Z',7),
    (211.13,'2022-02-10T13:31:20.916Z','2022-02-10T13:31:20.916Z',7),
    (253.51,'2022-02-10T13:40:31.749Z','2022-02-10T13:40:31.749Z',7),
    (253.51,'2022-02-10T13:42:45.777Z','2022-02-10T13:42:45.777Z',7),
    (253.51,'2022-02-10T13:44:56.683Z','2022-02-10T13:44:56.683Z',7),
    (253.51,'2022-02-10T13:47:07.750Z','2022-02-10T13:47:07.750Z',7),
    (253.51,'2022-02-10T13:49:20.097Z','2022-02-10T13:49:20.097Z',7),
    (253.51,'2022-02-10T13:51:32.408Z','2022-02-10T13:51:32.408Z',7),
    (253.51,'2022-02-10T13:53:44.330Z','2022-02-10T13:53:44.330Z',7),
    (253.51,'2022-02-10T13:55:55.491Z','2022-02-10T13:55:55.491Z',7),
    (253.51,'2022-02-10T13:58:07.325Z','2022-02-10T13:58:07.325Z',7),
    (253.51,'2022-02-10T14:00:09.156Z','2022-02-10T14:00:09.156Z',7),
    (253.51,'2022-02-10T14:02:21.771Z','2022-02-10T14:02:21.771Z',7),
    (253.51,'2022-02-10T14:04:33.766Z','2022-02-10T14:04:33.766Z',7),
    (253.51,'2022-02-10T14:06:45.638Z','2022-02-10T14:06:45.638Z',7),
    (253.51,'2022-02-10T14:08:57.540Z','2022-02-10T14:08:57.540Z',7),
    (253.51,'2022-02-10T14:10:59.806Z','2022-02-10T14:10:59.806Z',7),
    (247.16,'2022-02-11T09:13:59.539Z','2022-02-11T09:13:59.539Z',7),
    (159.76,'2022-02-11T09:16:13.268Z','2022-02-11T09:16:13.268Z',7),
    (158.76,'2022-02-11T09:17:13.658Z','2022-02-11T09:17:13.658Z',7),
    (157.71,'2022-02-11T09:19:25.690Z','2022-02-11T09:19:25.690Z',7),
    (156.73,'2022-02-11T09:20:29.265Z','2022-02-11T09:20:29.265Z',7),
    (156.73,'2022-02-11T09:21:30.596Z','2022-02-11T09:21:30.596Z',7),
    (157.13,'2022-02-11T09:23:41.774Z','2022-02-11T09:23:41.774Z',7),
    (155.56,'2022-02-11T09:29:08.998Z','2022-02-11T09:29:08.998Z',7),
    (157.36,'2022-02-11T09:30:11.192Z','2022-02-11T09:30:11.192Z',7),
    (153.71,'2022-02-11T13:00:01.421Z','2022-02-11T13:00:01.421Z',7),
    (153.71,'2022-02-11T13:02:14.428Z','2022-02-11T13:02:14.428Z',7),
    (153.71,'2022-02-11T13:03:15.753Z','2022-02-11T13:03:15.753Z',7),
    (153.71,'2022-02-11T13:03:18.672Z','2022-02-11T13:03:18.672Z',7),
    (153.71,'2022-02-11T13:03:21.906Z','2022-02-11T13:03:21.906Z',7),
    (153.71,'2022-02-11T13:03:24.895Z','2022-02-11T13:03:24.895Z',7),
    (153.71,'2022-02-11T13:03:27.703Z','2022-02-11T13:03:27.703Z',7),
    (153.71,'2022-02-11T13:03:30.370Z','2022-02-11T13:03:30.370Z',7),
    (153.71,'2022-02-11T13:03:33.110Z','2022-02-11T13:03:33.110Z',7),
    (153.71,'2022-02-11T13:03:35.928Z','2022-02-11T13:03:35.928Z',7),
    (153.71,'2022-02-11T13:03:39.763Z','2022-02-11T13:03:39.763Z',7),
    (153.71,'2022-02-11T13:04:16.847Z','2022-02-11T13:04:16.847Z',7),
    (153.71,'2022-02-11T13:04:24.560Z','2022-02-11T13:04:24.560Z',7),
    (153.71,'2022-02-11T13:05:16.531Z','2022-02-11T13:05:16.531Z',7),
    (153.71,'2022-02-11T13:05:20.115Z','2022-02-11T13:05:20.115Z',7),
    (153.71,'2022-02-11T13:05:22.653Z','2022-02-11T13:05:22.653Z',7),
    (153.71,'2022-02-11T13:06:17.982Z','2022-02-11T13:06:17.982Z',7),
    (153.71,'2022-02-11T13:07:20.083Z','2022-02-11T13:07:20.083Z',7),
    (153.71,'2022-02-11T13:07:23.189Z','2022-02-11T13:07:23.189Z',7),
    (153.71,'2022-02-11T13:07:26.393Z','2022-02-11T13:07:26.393Z',7),
    (153.71,'2022-02-11T13:07:28.752Z','2022-02-11T13:07:28.752Z',7),
    (153.71,'2022-02-11T13:07:31.184Z','2022-02-11T13:07:31.184Z',7),
    (153.71,'2022-02-11T13:07:35.174Z','2022-02-11T13:07:35.174Z',7),
    (153.71,'2022-02-11T13:07:37.828Z','2022-02-11T13:07:37.828Z',7),
    (153.71,'2022-02-11T13:08:26.872Z','2022-02-11T13:08:26.872Z',7),
    (153.71,'2022-02-11T13:08:29.525Z','2022-02-11T13:08:29.525Z',7),
    (153.71,'2022-02-11T13:09:20.820Z','2022-02-11T13:09:20.820Z',7),
    (153.71,'2022-02-11T13:11:22.652Z','2022-02-11T13:11:22.652Z',7),
    (153.71,'2022-02-11T13:11:25.752Z','2022-02-11T13:11:25.752Z',7),
    (153.71,'2022-02-11T13:12:23.708Z','2022-02-11T13:12:23.708Z',7),
    (153.71,'2022-02-11T13:14:26.956Z','2022-02-11T13:14:26.956Z',7),
    (153.71,'2022-02-11T13:16:30.484Z','2022-02-11T13:16:30.484Z',7),
    (153.71,'2022-02-11T13:16:33.106Z','2022-02-11T13:16:33.106Z',7),
    (153.71,'2022-02-11T13:16:35.401Z','2022-02-11T13:16:35.401Z',7),
    (153.71,'2022-02-11T13:17:29.166Z','2022-02-11T13:17:29.166Z',7),
    (153.71,'2022-02-11T13:17:31.438Z','2022-02-11T13:17:31.438Z',7),
    (153.71,'2022-02-11T13:17:33.786Z','2022-02-11T13:17:33.786Z',7),
    (153.71,'2022-02-11T13:18:32.195Z','2022-02-11T13:18:32.195Z',7),
    (153.71,'2022-02-11T13:18:35.004Z','2022-02-11T13:18:35.004Z',7),
    (153.71,'2022-02-11T13:18:37.367Z','2022-02-11T13:18:37.367Z',7),
    (153.71,'2022-02-11T13:18:39.964Z','2022-02-11T13:18:39.964Z',7),
    (153.71,'2022-02-11T13:19:35.844Z','2022-02-11T13:19:35.844Z',7),
    (153.71,'2022-02-11T13:21:32.800Z','2022-02-11T13:21:32.800Z',7),
    (153.71,'2022-02-11T13:22:35.529Z','2022-02-11T13:22:35.529Z',7),
    (153.71,'2022-02-11T13:22:38.129Z','2022-02-11T13:22:38.129Z',7),
    (153.71,'2022-02-11T13:22:40.918Z','2022-02-11T13:22:40.918Z',7),
    (153.71,'2022-02-11T13:22:45.895Z','2022-02-11T13:22:45.895Z',7),
    (153.71,'2022-02-11T13:22:48.651Z','2022-02-11T13:22:48.651Z',7),
    (153.71,'2022-02-11T13:22:51.015Z','2022-02-11T13:22:51.015Z',7),
    (153.71,'2022-02-11T13:22:53.455Z','2022-02-11T13:22:53.455Z',7),
    (153.71,'2022-02-11T13:23:35.406Z','2022-02-11T13:23:35.406Z',7),
    (153.71,'2022-02-11T13:25:37.459Z','2022-02-11T13:25:37.459Z',7),
    (153.71,'2022-02-11T13:25:41.075Z','2022-02-11T13:25:41.075Z',7),
    (153.71,'2022-02-11T13:26:37.845Z','2022-02-11T13:26:37.845Z',7),
    (153.71,'2022-02-11T13:28:39.799Z','2022-02-11T13:28:39.799Z',7),
    (153.71,'2022-02-11T13:31:24.451Z','2022-02-11T13:31:24.451Z',7),
    (153.71,'2022-02-11T13:32:43.852Z','2022-02-11T13:32:43.852Z',7),
    (153.71,'2022-02-11T13:34:46.498Z','2022-02-11T13:34:46.498Z',7),
    (153.71,'2022-02-11T13:36:52.496Z','2022-02-11T13:36:52.496Z',7),
    (153.71,'2022-02-11T13:38:51.015Z','2022-02-11T13:38:51.015Z',7),
    (153.71,'2022-02-11T13:39:53.304Z','2022-02-11T13:39:53.304Z',7),
    (153.71,'2022-02-11T13:40:52.024Z','2022-02-11T13:40:52.024Z',7),
    (153.71,'2022-02-11T13:42:06.249Z','2022-02-11T13:42:06.249Z',7),
    (153.71,'2022-02-11T13:42:54.647Z','2022-02-11T13:42:54.647Z',7),
    (153.71,'2022-02-11T13:44:57.285Z','2022-02-11T13:44:57.285Z',7),
    (153.71,'2022-02-11T13:46:58.111Z','2022-02-11T13:46:58.111Z',7),
    (153.71,'2022-02-11T13:49:05.625Z','2022-02-11T13:49:05.625Z',7)
;

INSERT INTO "TemperatureAlert" ("name", "minValue", "maxValue", "createdAt", "updatedAt") VALUES
    ('Cat', 38.1, 39.2, NOW(), NOW()),
    ('Dog', 37.9, 39.9, NOW(), NOW()),
    ('Horse', 37.2, 38.2, NOW(), NOW()),
    ('Chicken', 40.6, 43.0, NOW(), NOW()),
    ('Sheep', 38.3, 39.9, NOW(), NOW()),
    ('Goat', 38.5, 39.7, NOW(), NOW()),
    ('Cattle', 36.7, 39.1, NOW(), NOW()),
    ('Cow', 38.0, 39.3, NOW(), NOW()),
    ('Pig', 38.7, 39.8, NOW(), NOW()),
    ('Stable', 10.0, 15.0, NOW(), NOW())
;

INSERT INTO "HumidityAlert" ("name", "minValue", "maxValue", "createdAt", "updatedAt") VALUES
    ('Stable', 50.0, 75.0, NOW(), NOW())
;